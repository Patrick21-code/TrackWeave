<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile â€” TrackWeave</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@300;400;500;600&display=swap');
    body { font-family:'DM Sans',sans-serif; }
    @keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }
    .fade-up { animation:fadeUp .4s ease both; }

    .field {
      background:#1e2329; border:1.5px solid #2c3440; color:#fff;
      border-radius:8px; padding:11px 14px; width:100%; font-size:14px;
      outline:none; transition:border-color .2s;
    }
    .field:focus { border-color:#00e054; }
    .field::placeholder { color:#456; }
    textarea.field { resize:vertical; min-height:80px; }

    .btn-green {
      background:#00e054; color:#14181c; font-weight:600; border:none;
      border-radius:8px; padding:10px 20px; font-size:14px; cursor:pointer;
      transition:background .2s,transform .15s;
    }
    .btn-green:hover  { background:#00ff5e; transform:translateY(-1px); }
    .btn-green:disabled { opacity:.5; cursor:not-allowed; transform:none; }

    .avatar-ring { box-shadow:0 0 0 3px #00e054, 0 0 0 6px rgba(0,224,84,.15); }

    .post-card { transition:border-color .2s; }
    .post-card:hover { border-color:#456; }

    .tab { padding:8px 16px; border-radius:8px; font-size:13px; font-weight:500; cursor:pointer; transition:background .2s,color .2s; color:#678; background:none; border:none; }
    .tab.active { background:#2c3440; color:#fff; }

    .modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); backdrop-filter:blur(4px); z-index:50; align-items:center; justify-content:center; padding:16px; }
    .modal-bg.open { display:flex; }
  </style>
</head>
<body class="bg-[#14181c] text-[#9ab] min-h-screen">

  <!-- NAVBAR -->
  <nav class="bg-[#1e2329] border-b border-[#2c3440] py-3 sticky top-0 z-40">
    <div class="max-w-[900px] mx-auto px-6 flex items-center justify-between gap-6">
      <a href="/" class="flex items-center gap-2 no-underline">
        <div class="h-9 w-9 bg-[#00e054] rounded-md flex items-center justify-center flex-shrink-0">
          <span class="text-[#14181c] font-bold text-sm" style="font-family:'DM Serif Display',serif;">TW</span>
        </div>
        <span class="text-white font-semibold hidden sm:inline">TrackWeave</span>
      </a>
      <a href="/feed.html" class="text-[#9ab] text-sm hover:text-white transition-colors no-underline">â† Feed</a>
      <div id="navAuth" class="flex items-center gap-3"></div>
    </div>
  </nav>

  <div class="max-w-[900px] mx-auto px-6 py-8" id="pageContent">
    <div class="text-center py-20 text-[#456]">
      <div class="inline-block w-8 h-8 border-2 border-[#00e054] border-t-transparent rounded-full animate-spin mb-3"></div>
      <p>Loading profileâ€¦</p>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal-bg" id="editModal">
    <div class="bg-[#1e2329] rounded-2xl shadow-2xl w-full max-w-[480px] border border-[#2c3440]" style="animation:fadeUp .3s ease both">
      <div class="flex items-center justify-between p-6 border-b border-[#2c3440]">
        <h2 class="text-white font-semibold text-lg" style="font-family:'DM Serif Display',serif;">Edit Profile</h2>
        <button onclick="closeEdit()" class="text-[#456] hover:text-[#9ab] bg-transparent border-none cursor-pointer text-xl">&times;</button>
      </div>
      <div class="p-6 space-y-5">
        <!-- Avatar upload -->
        <div class="flex items-center gap-5">
          <div id="editAvatarPreview" class="flex-shrink-0"></div>
          <div>
            <label class="block text-[#9ab] text-xs font-medium mb-2 uppercase tracking-wider">Profile Picture</label>
            <label class="cursor-pointer inline-block py-2 px-4 rounded-lg border border-[#2c3440] text-[#9ab] text-sm hover:border-[#456] hover:text-white transition-all">
              Upload image
              <input type="file" id="avatarInput" class="sr-only" accept="image/jpeg,image/png,image/gif,image/webp" onchange="previewAvatar(event)"/>
            </label>
            <p class="text-[#456] text-xs mt-1">JPEG, PNG, GIF, WEBP Â· Max 2 MB</p>
          </div>
        </div>

        <div>
          <label class="block text-[#9ab] text-xs font-medium mb-1.5 uppercase tracking-wider">Display Name</label>
          <input id="editDisplayName" type="text" class="field" maxlength="60"/>
        </div>

        <div>
          <label class="block text-[#9ab] text-xs font-medium mb-1.5 uppercase tracking-wider">Bio</label>
          <textarea id="editBio" class="field" maxlength="500" placeholder="Tell the community about your music tasteâ€¦"></textarea>
          <p class="text-[#456] text-xs text-right mt-1"><span id="bioCount">0</span>/500</p>
        </div>

        <p id="editErr" class="hidden text-red-400 text-sm"></p>
        <p id="editOk"  class="hidden text-[#00e054] text-sm"></p>

        <div class="flex justify-end gap-3">
          <button onclick="closeEdit()" class="py-2.5 px-5 rounded-lg border border-[#2c3440] text-[#9ab] text-sm hover:border-[#456] transition-all cursor-pointer bg-transparent">Cancel</button>
          <button id="saveBtn" onclick="saveProfile()" class="btn-green text-sm px-6">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/api.js"></script>
  <script>
    const params   = new URLSearchParams(window.location.search);
    const username = params.get("u");
    let profileUser = null;
    let avatarFile  = null;

    (async () => {
      await initAuth();
      if (!username) { showErr("No username specified."); return; }
      try {
        profileUser = await API.getProfile(username);
        document.title = `@${profileUser.username} â€” TrackWeave`;
        renderProfile();
        loadUserPosts();
      } catch (err) {
        showErr(err.message);
      }
    })();

    function showErr(msg) {
      document.getElementById("pageContent").innerHTML = `<div class="text-center py-20 text-red-400">${msg}</div>`;
    }

    function renderProfile() {
      const u = profileUser;
      const me = Auth.getUser();
      const isMe = me?.username === u.username;
      const joinYear = new Date(u.created_at).getFullYear();

      document.getElementById("pageContent").innerHTML = `
        <!-- Header banner -->
        <div class="h-32 rounded-2xl mb-0 -mx-0" style="background:linear-gradient(135deg,#1a2236 0%,#0d1117 50%,#14181c 100%);border:1px solid #2c3440;border-bottom:none;border-radius:16px 16px 0 0;"></div>

        <!-- Avatar + info -->
        <div class="bg-[#1e2329] border border-[#2c3440] rounded-b-2xl px-6 pb-6 mb-8 fade-up" style="border-top:none;">
          <div class="flex flex-col sm:flex-row sm:items-end gap-4 -mt-10 mb-4">
            <div class="avatar-ring rounded-full flex-shrink-0" style="width:80px;height:80px;overflow:hidden;">
              ${u.avatar_url
                ? `<img src="${u.avatar_url}" class="w-full h-full object-cover" alt="${u.username}"/>`
                : `<div class="w-full h-full bg-[#00e054] flex items-center justify-center text-[#14181c] font-bold text-3xl" style="font-family:'DM Serif Display',serif;">${(u.display_name||u.username)[0].toUpperCase()}</div>`
              }
            </div>
            <div class="flex-1 min-w-0">
              <h1 class="text-white text-xl font-bold" style="font-family:'DM Serif Display',serif;">${escapeHtml(u.display_name || u.username)}</h1>
              <p class="text-[#456] text-sm">@${u.username} Â· Member since ${joinYear}</p>
            </div>
            ${isMe ? `<button onclick="openEdit()" class="btn-green text-sm px-5 py-2.5 flex-shrink-0">Edit Profile</button>` : ""}
          </div>
          ${u.bio ? `<p class="text-[#9ab] text-sm leading-relaxed">${escapeHtml(u.bio)}</p>` : `<p class="text-[#456] text-sm italic">No bio yet.</p>`}
        </div>

        <!-- Posts section -->
        <div>
          <h2 class="text-white font-semibold mb-4" style="font-family:'DM Serif Display',serif;">Posts by @${u.username}</h2>
          <div id="userPosts" class="space-y-3">
            <div class="text-center py-8 text-[#456]">
              <div class="inline-block w-5 h-5 border-2 border-[#456] border-t-transparent rounded-full animate-spin"></div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadUserPosts() {
      try {
        const posts = await API.userPosts(username);
        const list = document.getElementById("userPosts");
        if (!list) return;
        if (posts.length === 0) {
          list.innerHTML = `<div class="text-center py-12 text-[#456]"><p class="text-3xl mb-2">ğŸµ</p><p>No posts yet.</p></div>`;
          return;
        }
        list.innerHTML = posts.map((p, i) => `
          <div class="post-card bg-[#1e2329] border border-[#2c3440] rounded-xl p-4 fade-up" style="animation-delay:${i*0.05}s">
            <div class="flex items-center gap-2 mb-2 text-xs text-[#456]">
              <span>${timeAgo(p.created_at)}</span>
              <span>â€¢</span>
              <span>${p.score >= 0 ? "+" : ""}${p.score} points</span>
              <span>â€¢</span>
              <span>${p.comment_count} comment${p.comment_count !== 1 ? "s" : ""}</span>
            </div>
            <a href="/post.html?id=${p.id}" class="no-underline">
              <h3 class="text-white font-semibold text-sm hover:text-[#00e054] transition-colors leading-snug mb-1">${escapeHtml(p.title)}</h3>
            </a>
            ${p.body ? `<p class="text-[#678] text-xs leading-relaxed line-clamp-2">${escapeHtml(p.body)}</p>` : ""}
            ${p.link_url ? `<a href="${p.link_url}" target="_blank" rel="noopener" class="text-[#00e054] text-xs hover:underline">ğŸ”— Link</a>` : ""}
          </div>`).join("");
      } catch (err) {
        const list = document.getElementById("userPosts");
        if (list) list.innerHTML = `<p class="text-red-400 text-sm">${err.message}</p>`;
      }
    }

    // â”€â”€ Edit profile modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openEdit() {
      const u = profileUser;
      document.getElementById("editDisplayName").value = u.display_name || "";
      document.getElementById("editBio").value = u.bio || "";
      document.getElementById("bioCount").textContent = (u.bio || "").length;
      document.getElementById("editAvatarPreview").innerHTML = u.avatar_url
        ? `<img src="${u.avatar_url}" class="w-16 h-16 rounded-full object-cover avatar-ring" />`
        : `<div class="w-16 h-16 rounded-full bg-[#00e054] flex items-center justify-center text-[#14181c] font-bold text-2xl avatar-ring" style="font-family:'DM Serif Display',serif;">${(u.display_name||u.username)[0].toUpperCase()}</div>`;
      document.getElementById("editModal").classList.add("open");
    }
    function closeEdit() { document.getElementById("editModal").classList.remove("open"); }

    document.getElementById("editBio")?.addEventListener("input", function() {
      document.getElementById("bioCount").textContent = this.value.length;
    });

    function previewAvatar(e) {
      const file = e.target.files[0];
      if (!file) return;
      avatarFile = file;
      const reader = new FileReader();
      reader.onload = (ev) => {
        document.getElementById("editAvatarPreview").innerHTML =
          `<img src="${ev.target.result}" class="w-16 h-16 rounded-full object-cover avatar-ring" />`;
      };
      reader.readAsDataURL(file);
    }

    async function saveProfile() {
      const displayName = document.getElementById("editDisplayName").value.trim();
      const bio = document.getElementById("editBio").value.trim();
      const errEl = document.getElementById("editErr");
      const okEl  = document.getElementById("editOk");
      errEl.classList.add("hidden");
      okEl.classList.add("hidden");

      const btn = document.getElementById("saveBtn");
      btn.disabled = true;
      btn.textContent = "Savingâ€¦";

      try {
        // Upload avatar if changed
        if (avatarFile) {
          const updated = await API.uploadAvatar(avatarFile);
          Auth.saveUser(updated);
          profileUser = updated;
          avatarFile = null;
        }

        // Update profile fields
        const updated = await API.updateProfile({ display_name: displayName, bio });
        Auth.saveUser(updated);
        profileUser = updated;

        okEl.textContent = "Profile saved!";
        okEl.classList.remove("hidden");
        setTimeout(() => {
          closeEdit();
          renderProfile();
          loadUserPosts();
          renderNavAuth();
        }, 800);
      } catch (err) {
        errEl.textContent = err.message;
        errEl.classList.remove("hidden");
      } finally {
        btn.disabled = false;
        btn.textContent = "Save Changes";
      }
    }

    document.getElementById("editModal").addEventListener("click", function(e) {
      if (e.target === this) closeEdit();
    });

    // â”€â”€ Utility â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escapeHtml(s) {
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }
  </script>
</body>
</html>
