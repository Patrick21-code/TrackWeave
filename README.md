# TrackWeave — Full-Stack Setup Guide

A Reddit-style music social platform built with **FastAPI + PostgreSQL** on the backend and plain HTML/JS (Tailwind) on the frontend.

---

## Project Structure

```
trackweave/
├── backend/
│   ├── main.py                  # FastAPI app entry point
│   ├── core/
│   │   ├── database.py          # SQLAlchemy engine + session
│   │   ├── security.py          # bcrypt password hashing + JWT
│   │   └── deps.py              # Auth dependency (get_current_user)
│   ├── models/
│   │   ├── user.py              # User table
│   │   ├── post.py              # Post table
│   │   ├── comment.py           # Comment table (nested replies)
│   │   └── vote.py              # Vote table (+1 / -1)
│   ├── schemas/
│   │   ├── user.py              # Pydantic request/response models
│   │   ├── post.py
│   │   ├── comment.py
│   │   └── vote.py
│   └── routers/
│       ├── auth.py              # Register, login, refresh, /me
│       ├── users.py             # Profile, avatar upload
│       ├── posts.py             # Feed, CRUD posts
│       ├── comments.py          # CRUD comments + replies
│       └── votes.py             # Upvote / downvote
├── frontend/
│   ├── api.js                   # Shared JS API client (JWT-aware)
│   ├── index.html               # Landing page (main.html, modified)
│   ├── register.html            # Create account
│   ├── signin.html              # Sign in
│   ├── feed.html                # Post feed + create post
│   ├── post.html                # Single post + comments
│   └── profile.html             # User profile + avatar upload
├── requirements.txt
├── setup_db.sql
└── .env.example
```

---

## 1. Prerequisites

| Tool | Version |
|------|---------|
| Python | 3.11+ |
| PostgreSQL | 14+ |
| pip | any recent |

---

## 2. Database Setup

```bash
# Connect as the postgres superuser and run the setup script
psql -U postgres -f setup_db.sql
```

This creates:
- User: `trackweave_user` / `trackweave_pass`
- Database: `trackweave_db`

> **Production tip:** use a strong random password and update `DATABASE_URL` accordingly.

---

## 3. Python Environment

```bash
cd trackweave

# Create and activate virtual environment
python -m venv venv
source venv/bin/activate        # Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

---

## 4. Environment Variables

```bash
cp .env.example .env
# Edit .env and set your own SECRET_KEY and DATABASE_URL
```

Generate a secure secret key:
```bash
openssl rand -hex 32
```

---

## 5. Run the Server

```bash
# From the project root (trackweave/)
uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
```

The app will:
1. Connect to PostgreSQL
2. **Auto-create all tables** on first run
3. Serve the API at `http://localhost:8000/api/`
4. Serve the frontend at `http://localhost:8000/`

---

## 6. Open in Browser

| URL | Page |
|-----|------|
| `http://localhost:8000/` | Landing page |
| `http://localhost:8000/register.html` | Create account |
| `http://localhost:8000/signin.html` | Sign in |
| `http://localhost:8000/feed.html` | Post feed |
| `http://localhost:8000/post.html?id=1` | Single post |
| `http://localhost:8000/profile.html?u=username` | User profile |

---

## 7. API Reference

Interactive docs are auto-generated by FastAPI:

- **Swagger UI:** `http://localhost:8000/docs`
- **ReDoc:** `http://localhost:8000/redoc`

### Key Endpoints

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| `POST` | `/api/auth/register` | ❌ | Register new account |
| `POST` | `/api/auth/login` | ❌ | Login → returns JWT tokens |
| `POST` | `/api/auth/refresh` | ❌ | Refresh access token |
| `GET`  | `/api/auth/me` | ✅ | Get own profile |
| `GET`  | `/api/posts/` | ❌ | Get feed (`?sort=new\|top`) |
| `POST` | `/api/posts/` | ✅ | Create post |
| `GET`  | `/api/posts/{id}` | ❌ | Get single post |
| `PATCH`| `/api/posts/{id}` | ✅ | Edit post (author only) |
| `DELETE`| `/api/posts/{id}` | ✅ | Delete post (author only) |
| `GET`  | `/api/comments/post/{id}` | ❌ | Get comments for post |
| `POST` | `/api/comments/post/{id}` | ✅ | Create comment or reply |
| `DELETE`| `/api/comments/{id}` | ✅ | Delete comment |
| `POST` | `/api/votes/` | ✅ | Cast/change/remove vote |
| `GET`  | `/api/users/{username}` | ❌ | Get public profile |
| `PATCH`| `/api/users/me` | ✅ | Update display name / bio |
| `POST` | `/api/users/me/avatar` | ✅ | Upload avatar (multipart) |

---

## 8. Authentication Flow

```
Register  →  POST /api/auth/register
Login     →  POST /api/auth/login  →  { access_token, refresh_token }
             Store both tokens in localStorage (via api.js)
Each API call  →  Authorization: Bearer <access_token>
Token expires  →  api.js auto-calls /api/auth/refresh transparently
```

Passwords are hashed with **bcrypt** (via passlib). JWTs are signed with **HS256**.

---

## 9. Production Checklist

- [ ] Change `SECRET_KEY` to a cryptographically random 32-byte hex string
- [ ] Change PostgreSQL password from the default
- [ ] Set `allow_origins` in CORS middleware to your actual domain
- [ ] Run behind a reverse proxy (nginx / Caddy) with HTTPS
- [ ] Use Alembic for schema migrations instead of `create_all`
- [ ] Add rate limiting (e.g., slowapi)
- [ ] Store avatars in object storage (S3 / Cloudflare R2) instead of DB base64

---

## 10. Features Included

- ✅ **Register & Sign In** — bcrypt passwords, JWT access + refresh tokens
- ✅ **User Profiles** — display name, bio, avatar upload (stored as base64)
- ✅ **Post Feed** — create text or link posts, sort by New or Top
- ✅ **Comments** — nested replies up to 4 levels deep
- ✅ **Upvote / Downvote** — on both posts and comments, toggle-off support
- ✅ **Auth-aware UI** — navbar adapts based on login state
- ✅ **Soft deletes** — posts/comments marked deleted, not removed from DB
- ✅ **Auto-refresh tokens** — seamless re-auth without logout
